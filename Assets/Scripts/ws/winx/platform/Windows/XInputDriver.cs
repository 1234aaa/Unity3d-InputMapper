//------------------------------------------------------------------------------
// <auto-generated>
//     This code was generated by a tool.
//     Runtime Version:4.0.30319.17929
//
//     Changes to this file may cause incorrect behavior and will be lost if
//     the code is regenerated.
// </auto-generated>
//------------------------------------------------------------------------------
using System;
using ws.winx.platform;
using System.Runtime.InteropServices;
using ws.winx.devices;
using UnityEngine;

namespace ws.winx.platform.windows
{
    public class XInputDriver : IJoystickDriver
    {

        XInputState state;
        IHIDInterface _hidInterface;
        int _lastFrameNum = -1;
        IntPtr xInputStatePtr;

        private const float XINPUT_GAMEPAD_LEFT_THUMB_DEADZONE = 0.239f;//7849;
        private const float XINPUT_GAMEPAD_RIGHT_THUMB_DEADZONE = 0.265f;//8689
        private const float XINPUT_GAMEPAD_TRIGGER_THRESHOLD = 0.117f;// 30;
        private const float ERROR_SUCCESS = 0;


        public enum XTYPE : int
        {
            XBOX = 0,
            XBOX360,
            XBOX360W
        }


        /// <summary>
        /// 
        /// Need Direct X to be install
        /// Dependent of XInputInterface.dll wrapper calls of (xinput1_3.dll)
        /// </summary>
        public XInputDriver()
        {
            xInputStatePtr = Marshal.AllocHGlobal(Marshal.SizeOf(typeof(XInputState)));

        }

        int[] XPAD_DEVICE = new int[] {
 	             0x045e, 0x0202, /* "Microsoft X-Box pad v1 (US)",0*/  (int)XTYPE.XBOX ,
	             0x045e, 0x0289, /* "Microsoft X-Box pad v2 (US)", 0*/ (int)XTYPE.XBOX ,
 	             0x045e, 0x0285,  /*"Microsoft X-Box pad (Japan)", 0*/ (int)XTYPE.XBOX ,
 	             0x045e, 0x0287,  /*"Microsoft Xbox Controller S", 0*/(int) XTYPE.XBOX ,
	             0x045e, 0x0289,  /*"Microsoft X-Box pad v2 (US)", 0*/ (int)XTYPE.XBOX ,
	             0x045e, 0x028e, /*Microsoft X-Box 360 pad", 0,*/ (int)XTYPE.XBOX360, 
	             0x045e, 0x0291,/*Xbox 360 Wireless Receiver (XBOX)", MAP_DPAD_TO_BUTTONS*/(int) XTYPE.XBOX360W ,
 	             0x045e, 0x0719,/*Xbox 360 Wireless Receiver", MAP_DPAD_TO_BUTTONS*/(int) XTYPE.XBOX360W ,
	             0x0c12, 0x8809,/*RedOctane Xbox Dance Pad", DANCEPAD_MAP_CONFIG*/ (int)XTYPE.XBOX, 
 	             0x044f, 0x0f07,/*Thrustmaster, Inc. Controller", 0*/ (int)XTYPE.XBOX ,
 	             0x046d, 0xc242,/*Logitech Chillstream Controller", 0*/ (int)XTYPE.XBOX360 ,
 	             0x046d, 0xca84,/*Logitech Xbox Cordless Controller", 0*/ (int)XTYPE.XBOX ,
 	             0x0738, 0x4540,/*Mad Catz Beat Pad", MAP_DPAD_TO_BUTTONS*/ (int)XTYPE.XBOX ,
 	             0x0738, 0x4556,/*Mad Catz Lynx Wireless Controller", 0*/ (int)XTYPE.XBOX ,
 	             0x0738, 0x4716,/*Mad Catz Wired Xbox 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x0738, 0x4728,/*Mad Catz Street Fighter IV FightPad", XTYPE_XBOX360 
 	             0x0738, 0x4738,/*Mad Catz Wired Xbox 360 Controller (SFIV)", MAP_TRIGGERS_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
 	             0x0738, 0x6040,/*Mad Catz Beat Pad Pro", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX, 
	             0x0738, 0xbeef,/*Mad Catz JOYTECH NEO SE Advanced GamePad",*/ (int)XTYPE.XBOX360 ,
 	             0x0c12, 0x8802,/*Zeroplus Xbox Controller", */ (int)XTYPE.XBOX, 
	             0x0c12, 0x8809,/*RedOctane Xbox Dance Pad", DANCEPAD_MAP_CONFIG,*/ (int)XTYPE.XBOX, 
 	             0x0c12, 0x880a,/*Pelican Eclipse PL-2023", */ (int)XTYPE.XBOX, 
 	             0x0c12, 0x8810,/*Zeroplus Xbox Controller", */ (int)XTYPE.XBOX, 
 	             0x0c12, 0x9902,/*HAMA VibraX - *FAULTY HARDWARE*", */ (int)XTYPE.XBOX, 
 	             0x0e6f, 0x0003,/*Logic3 Freebird wireless Controller", */ (int)XTYPE.XBOX, 
 	             0x0e6f, 0x0005,/*Eclipse wireless Controller", */ (int)XTYPE.XBOX, 
 	             0x0e6f, 0x0006,/*Edge wireless Controller", */ (int)XTYPE.XBOX, 
	             0x0e6f, 0x0006,/*Pelican 'TSZ' Wired Xbox 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x0e6f, 0x0105,/*HSM3 Xbox360 dancepad", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
 	             0x0e6f, 0x0201,/*Pelican PL-3601 'TSZ' Wired Xbox 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x0e6f, 0x0213,/*Afterglow Gamepad for Xbox 360", */ (int)XTYPE.XBOX360 ,
 	             0x0e8f, 0x0201,/*SmartJoy Frag Xpad/PS2 adaptor", */ (int)XTYPE.XBOX, 
	             0x0f0d, 0x000d,/*Hori Fighting Stick EX2", MAP_TRIGGERS_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
	             0x0f0d, 0x0016,/*Hori Real Arcade Pro.EX", MAP_TRIGGERS_TO_BUTTONS, */(int)XTYPE.XBOX360 ,
 	             0x0f30, 0x0202,/*Joytech Advanced Controller", */ (int)XTYPE.XBOX, 
 	             0x0f30, 0x8888,/*BigBen XBMiniPad Controller", */ (int)XTYPE.XBOX, 
 	             0x102c, 0xff0c,/*Joytech Wireless Advanced Controller", */ (int)XTYPE.XBOX, 
	             0x12ab, 0x8809,/*Xbox DDR dancepad", MAP_DPAD_TO_BUTTONS, */(int)XTYPE.XBOX, 
 	             0x12ab, 0x0004,/*Honey Bee Xbox360 dancepad", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
	             0x0e6f, 0x0105,/*HSM3 Xbox360 dancepad", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
	             0x12ab, 0x8809,/*Xbox DDR dancepad", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX, 
 	             0x1430, 0x4748,/*RedOctane Guitar Hero X-plorer", */ (int)XTYPE.XBOX360 ,
 	             0x1430, 0x8888,/*TX6500+ Dance Pad (first generation)", MAP_DPAD_TO_BUTTONS, (int)XTYPE.XTYPE_XBOX, 
 	             0x146b, 0x0601,/*BigBen Interactive XBOX 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x045e, 0x028e,/*Microsoft X-Box 360 pad", */ (int)XTYPE.XBOX360 ,
	             0x1689, 0xfd00,/*Razer Onza Tournament Edition", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
 	             0x1bad, 0x0002,/*Harmonix Rock Band Guitar", */ (int)XTYPE.XBOX360 ,
 	             0x1bad, 0x0003,/*Harmonix Rock Band Drumkit", MAP_DPAD_TO_BUTTONS, */(int)XTYPE.XBOX360 ,
	             0x0f0d, 0x0016,/*Hori Real Arcade Pro.EX", MAP_TRIGGERS_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
	             0x0f0d, 0x000d,/*Hori Fighting Stick EX2", MAP_TRIGGERS_TO_BUTTONS, */(int)XTYPE.XBOX360 ,
	             0x1689, 0xfd00,/*Razer Onza Tournament Edition", MAP_DPAD_TO_BUTTONS,*/ (int)XTYPE.XBOX360 ,
	             0x1bad, 0xf016,/*Mad Catz Xbox 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x1bad, 0xf028,/*Street Fighter IV FightPad", */ (int)XTYPE.XBOX360 ,
	             0x1bad, 0xf901,/*Gamestop Xbox 360 Controller", */ (int)XTYPE.XBOX360 ,
	             0x1bad, 0xf903,/*Tron Xbox 360 controller", */ (int)XTYPE.XBOX360 ,
	             0x24c6, 0x5300,/*PowerA MINI PROEX Controller", */ (int)XTYPE.XBOX360 ,
 	             0xffff, 0xffff,/*Chinese-made Xbox Controller", */ (int)XTYPE.XBOX
                 
 	            
 };







        #region IJoystickDriver implementation

        public void Update(IJoystickDevice joystick)
        //public void Update (IJoystickDevice<ws.winx.devices.IAxisDetails, ws.winx.devices.IButtonDetails, ws.winx.devices.IDeviceExtension> joystick)
        {
            GamePad gamePad;

            //don't update in same frame twice
            if (_lastFrameNum == Time.frameCount)
                return;
            else _lastFrameNum = Time.frameCount;




            if (UnsafeNativeMethods.XInputGamePadGetState((uint)joystick.ID, xInputStatePtr) == 0)
            {
                state = (XInputState)Marshal.PtrToStructure(xInputStatePtr, typeof(XInputState));
                gamePad = state.Gamepad;



                //////////////////////////////////// BUTTONS ////////////////////////////////////////
                joystick.Buttons[0].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_START);
                joystick.Buttons[1].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_BACK);
                joystick.Buttons[2].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_LEFT_THUMB);
                joystick.Buttons[3].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_RIGHT_THUMB);
                joystick.Buttons[4].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_LEFT_SHOULDER);
                joystick.Buttons[5].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_RIGHT_SHOULDER);
                joystick.Buttons[6].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_A);
                joystick.Buttons[7].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_B);
                joystick.Buttons[8].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_X);
                joystick.Buttons[9].value = (float)(gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_Y);



                //////////////////////////////  POV ////////////////////////////////////////
                float x = 0, y = 0;

                if ((gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_DPAD_UP) != 0) y = 1;
                else if ((gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_DPAD_DOWN) != 0) y = -1;

                if ((gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_DPAD_LEFT) != 0) x = -1;
                else if ((gamePad.dwButtons & (ushort)ButtonsFlags.XINPUT_GAMEPAD_DPAD_RIGHT) != 0) x = 1;

                joystick.Axis[JoystickAxis.AxisPovX].value = x;
                joystick.Axis[JoystickAxis.AxisPovY].value = y;




                ////////////////////////// AXIS //////////////////////////////////
                IAxisDetails axisDetails;

                axisDetails = joystick.Axis[JoystickAxis.AxisX];
                axisDetails.value = NormalizeAxis((float)gamePad.sThumbLX, axisDetails.min, axisDetails.max);


                axisDetails = joystick.Axis[JoystickAxis.AxisY];
                axisDetails.value = NormalizeAxis((float)gamePad.sThumbLY, axisDetails.min, axisDetails.max);


                axisDetails = joystick.Axis[JoystickAxis.AxisZ];
                axisDetails.value = NormalizeAxis((float)gamePad.sThumbRX, axisDetails.min, axisDetails.max);


                axisDetails = joystick.Axis[JoystickAxis.AxisR];
                axisDetails.value = NormalizeAxis((float)gamePad.sThumbRY, axisDetails.min, axisDetails.max);

                axisDetails = joystick.Axis[JoystickAxis.AxisU];
                axisDetails.value = NormalizeAxis((float)gamePad.bLeftTrigger, axisDetails.min, axisDetails.max);

                axisDetails = joystick.Axis[JoystickAxis.AxisV];
                axisDetails.value = NormalizeAxis((float)gamePad.bRightTrigger, axisDetails.min, axisDetails.max);



            }






        }

        public IJoystickDevice ResolveDevice(IHIDDeviceInfo info)
        //public IJoystickDevice<IAxisDetails, IButtonDetails, IDeviceExtension> ResolveDevice(IHIDDeviceInfo info)
        {
            int type = -1;
            int len = XPAD_DEVICE.Length;
            for (int i = 0; i < len; i += 3)
            {
                if (info.VID == XPAD_DEVICE[i] && info.PID == XPAD_DEVICE[i + 1])
                {
                    type = XPAD_DEVICE[i + 2];
                    break;
                }
            }

            if (type < 0) return null;

            XInputDevice joystick;
            int inx = 0;

            _hidInterface = info.hidInterface;


            joystick = new XInputDevice(info.index, info.PID, info.VID, 8, 10, this, type);


            //inti button structure
            for (; inx < 10; inx++)
            {
                joystick.Buttons[inx] = new ButtonDetails();
            }



            AxisDetails axisDetails;

            //LX
            axisDetails = new AxisDetails();
            axisDetails.max = 32767;
            axisDetails.min = -32767;
            joystick.Axis[JoystickAxis.AxisX] = axisDetails;

            //LY
            axisDetails = new AxisDetails();
            axisDetails.max = 32767;
            axisDetails.min = -32767;
            joystick.Axis[JoystickAxis.AxisY] = axisDetails;

            //RX
            axisDetails = new AxisDetails();
            axisDetails.max = 32767;
            axisDetails.min = -32767;
            joystick.Axis[JoystickAxis.AxisZ] = axisDetails;

            //RY
            axisDetails = new AxisDetails();
            axisDetails.max = 32767;
            axisDetails.min = -32767;
            joystick.Axis[JoystickAxis.AxisR] = axisDetails;


            //TRIGGERS
            axisDetails = new AxisDetails();
            axisDetails.max = 255;
            axisDetails.min = 0;
            joystick.Axis[JoystickAxis.AxisU] = axisDetails;

            axisDetails = new AxisDetails();
            axisDetails.max = 255;
            axisDetails.min = 0;
            joystick.Axis[JoystickAxis.AxisV] = axisDetails;

            //POV
            axisDetails = new AxisDetails();
            axisDetails.isHat = true;
            joystick.Axis[JoystickAxis.AxisPovX] = axisDetails;
            axisDetails = new AxisDetails();
            axisDetails.isHat = true;
            joystick.Axis[JoystickAxis.AxisPovY] = axisDetails;


            return joystick;
            //return (IJoystickDevice<AxisDetails, ButtonDetails, XInputExtension>)joystick;
        }
        #endregion


        /// <summary>
        ///  Normalize raw axis value to 0-1 range.
        /// </summary>
        /// <param name="pos"></param>
        /// <param name="min"></param>
        /// <param name="max"></param>
        /// <param name="dreadZone"></param>
        /// <returns></returns>
        public float NormalizeTrigger(float pos, int min, int max, float dreadZone = 0.001f)
        {
            float value = pos / (max - min);
            if (value < dreadZone && value > -dreadZone)
                return 0;

            return value;

        }

        private float NormalizeAxis(float pos, int min, int max, float dreadZone = 0.001f)
        {
            //UnityEngine.Debug.Log(Min[axis]+" Max:"+Max[axis]);

            float offset = (2 * (pos - min)) / (max - min) - 1;
            if (offset > 1)
                return 1;
            else if (offset < -1)
                return -1;
            else if (offset < dreadZone && offset > -dreadZone)
                return 0;
            else
                return offset;
        }


        internal struct Vibration
        {
            public ushort LeftMotorSpeed;
            public ushort RightMotorSpeed;
            public Vibration(ushort left, ushort right)
            {
                this.LeftMotorSpeed = left;
                this.RightMotorSpeed = right;
            }
        }





        public struct GamePad
        {
            public ushort dwButtons;
            public byte bLeftTrigger;
            public byte bRightTrigger;
            public short sThumbLX;
            public short sThumbLY;
            public short sThumbRX;
            public short sThumbRY;
        }


        public enum ButtonsFlags : ushort
        {
            XINPUT_GAMEPAD_DPAD_UP = 0x00000001,
            XINPUT_GAMEPAD_DPAD_DOWN = 0x00000002,
            XINPUT_GAMEPAD_DPAD_LEFT = 0x00000004,
            XINPUT_GAMEPAD_DPAD_RIGHT = 0x00000008,
            XINPUT_GAMEPAD_START = 0x00000010,
            XINPUT_GAMEPAD_BACK = 0x00000020,
            XINPUT_GAMEPAD_LEFT_THUMB = 0x00000040,
            XINPUT_GAMEPAD_RIGHT_THUMB = 0x00000080,
            XINPUT_GAMEPAD_LEFT_SHOULDER = 0x0100,
            XINPUT_GAMEPAD_RIGHT_SHOULDER = 0x0200,
            XINPUT_GAMEPAD_A = 0x1000,
            XINPUT_GAMEPAD_B = 0x2000,
            XINPUT_GAMEPAD_X = 0x4000,
            XINPUT_GAMEPAD_Y = 0x8000
        }





        public struct XInputState
        {
            public uint dwPacketNumber;
            public GamePad Gamepad;


        }



        internal void SetMotor(XInputDevice device, float leftMotor, float rightMotor)
        {
            UnsafeNativeMethods.XInputGamePadSetState((uint)device.ID, leftMotor, rightMotor);
        }



        static class UnsafeNativeMethods
        {
            internal const string DLLName = "XInputInterface";

            [DllImport(DLLName)]
            public static extern uint XInputGamePadGetState(uint playerIndex, IntPtr state);
            [DllImport(DLLName)]
            public static extern void XInputGamePadSetState(uint playerIndex, float leftMotor, float rightMotor);

        }



        #region ButtonDetails
        public sealed class ButtonDetails : IButtonDetails
        {

            #region Fields

            float _value;
            uint _uid;
            JoystickButtonState _buttonState;

            #region IDeviceDetails implementation


            public uint uid
            {
                get
                {
                    return _uid;
                }
                set
                {
                    _uid = value;
                }
            }




            public JoystickButtonState buttonState
            {
                get { return _buttonState; }
            }



            public float value
            {
                get
                {
                    return _value;
                    //return (_buttonState==JoystickButtonState.Hold || _buttonState==JoystickButtonState.Down);
                }
                set
                {

                    _value = value;
                    //if pressed==TRUE
                    //TODO check the code with triggers
                    if (value > 0)
                    {
                        if (_buttonState == JoystickButtonState.None
                            || _buttonState == JoystickButtonState.Up)
                        {

                            _buttonState = JoystickButtonState.Down;



                        }
                        else
                        {
                            //if (buttonState == JoystickButtonState.Down)
                            _buttonState = JoystickButtonState.Hold;

                        }


                    }
                    else
                    { //
                        if (_buttonState == JoystickButtonState.Down
                            || _buttonState == JoystickButtonState.Hold)
                        {
                            _buttonState = JoystickButtonState.Up;
                        }
                        else
                        {//if(buttonState==JoystickButtonState.Up){
                            _buttonState = JoystickButtonState.None;
                        }

                    }
                }
            }
            #endregion
            #endregion

            #region Constructor
            public ButtonDetails(uint uid = 0) { this.uid = uid; }
            #endregion






        }

        #endregion

        #region AxisDetails
        public sealed class AxisDetails : IAxisDetails
        {

            #region Fields
            float _value;
            int _uid;
            int _min;
            int _max;
            JoystickButtonState _buttonState;
            bool _isNullable;
            bool _isHat;
            bool _isTrigger;


            #region IAxisDetails implementation



            public bool isTrigger
            {
                get
                {
                    return _isTrigger;
                }
                set
                {
                    _isTrigger = value;
                }
            }



            public int min
            {
                get
                {
                    return _min;
                }
                set
                {
                    _min = value;
                }
            }


            public int max
            {
                get
                {
                    return _max;
                }
                set
                {
                    _max = value;
                }
            }


            public bool isNullable
            {
                get
                {
                    return _isNullable;
                }
                set
                {
                    _isNullable = value;
                }
            }


            public bool isHat
            {
                get
                {
                    return _isHat;
                }
                set
                {
                    _isHat = value;
                }
            }


            #endregion


            #region IDeviceDetails implementation


            public uint uid
            {
                get
                {
                    throw new NotImplementedException();
                }
                set
                {
                    throw new NotImplementedException();
                }
            }


            #endregion

            public JoystickButtonState buttonState
            {
                get { return _buttonState; }
            }
            public float value
            {
                get { return _value; }
                set
                {

                    if (value == 0)
                    {
                        if (_buttonState == JoystickButtonState.Down
                            || _buttonState == JoystickButtonState.Hold)
                        {

                            //axis float value isn't yet update so it have value before getting 0
                            if (_value > 0)//0 come after positive values
                                _buttonState = JoystickButtonState.PosToUp;
                            else
                                _buttonState = JoystickButtonState.NegToUp;

                        }
                        else
                        {//if(buttonState==JoystickButtonState.Up){
                            _buttonState = JoystickButtonState.None;
                        }


                    }
                    else
                    {
                        if (_buttonState == JoystickButtonState.None
                            || _buttonState == JoystickButtonState.Up)
                        {

                            _buttonState = JoystickButtonState.Down;

                        }
                        else
                        {
                            _buttonState = JoystickButtonState.Hold;
                        }


                    }

                    _value = value;



                }//set
            }

            #endregion

        }

        #endregion



        sealed class XInputExtension : IDeviceExtension
        {

        }




    }
}

